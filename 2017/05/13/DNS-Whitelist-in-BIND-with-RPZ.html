<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>DNS Whitelist in BIND with RPZ</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="http://blog.rankinrez.net/favicon.ico">

    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:400,700,400italic,700italic|Open+Sans:400italic,700italic,700,400">
    <link rel="stylesheet" type="text/css" href="//blog.rankinrez.net/themes/roon/assets/css/screen.css?v=1494704743780" />

    <link rel="canonical" href="http://blog.rankinrez.net/2017/05/13/DNS-Whitelist-in-BIND-with-RPZ.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="DNS Whitelist in BIND with RPZ" />
    <meta property="og:description" content="I recently got a Samsung &#x27;smart&#x27; TV which is very nice to look at. Unfortunately there have been numerous security and privacy issues with smart TVs of all kinds, and Samsung in particular.  Being predictably paranoid I therefore blocked the TV&amp;#8217;s IP address on my router to stop" />
    <meta property="og:url" content="http://blog.rankinrez.net/2017/05/13/DNS-Whitelist-in-BIND-with-RPZ.html" />
    <meta property="article:published_time" content="2017-05-13T00:00:00.000Z" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="DNS Whitelist in BIND with RPZ" />
    <meta name="twitter:description" content="I recently got a Samsung &#x27;smart&#x27; TV which is very nice to look at. Unfortunately there have been numerous security and privacy issues with smart TVs of all kinds, and Samsung in particular.  Being predictably paranoid I therefore blocked the TV&amp;#8217;s IP address on my router to stop" />
    <meta name="twitter:url" content="http://blog.rankinrez.net/2017/05/13/DNS-Whitelist-in-BIND-with-RPZ.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "",
    "author": {
        "@type": "Person",
        "name": "Cathal Mooney",
        "image": "https://avatars1.githubusercontent.com/u/4465905?v=3",
        "url": "http://blog.rankinrez.net/author/topranks/"
    },
    "headline": "DNS Whitelist in BIND with RPZ",
    "url": "http://blog.rankinrez.net/2017/05/13/DNS-Whitelist-in-BIND-with-RPZ.html",
    "datePublished": "2017-05-13T00:00:00.000Z",
    "description": "I recently got a Samsung &#x27;smart&#x27; TV which is very nice to look at. Unfortunately there have been numerous security and privacy issues with smart TVs of all kinds, and Samsung in particular.  Being predictably paranoid I therefore blocked the TV&amp;#8217;s IP address on my router to stop"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="" href="http://blog.rankinrez.net/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/styles/atom-one-dark.min.css">
</head>
<body class="post-template  noimage">

    


    <article role="main" class="">
        <header>
            <a href="http://blog.rankinrez.net" id="home_link">Â«</a>
            <div class="meta"><time datetime="2017-05-13"><a href="http://blog.rankinrez.net/2017/05/13/DNS-Whitelist-in-BIND-with-RPZ.html">May 13, 2017</a></time> <span class="count" id="js-reading-time"></span></div>
            <h1>DNS Whitelist in BIND with RPZ</h1>
        </header>

        <div class="text" id="js-post-content">
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>I recently got a Samsung 'smart' TV which is very nice to look at.</p>
</div>
<div class="paragraph">
<p>Unfortunately there have been numerous security and privacy issues with smart TVs of all kinds, and Samsung in <a href="http://www.bbc.com/news/technology-31296188">particular</a>.  Being predictably paranoid I therefore blocked the TV&#8217;s IP address on my router to stop it getting to the internet.</p>
</div>
<div class="paragraph">
<p>As it turns out however, the built-in Netflix app on the TV is my only option for 4k Netflix (my HTPC was out due to not having a Kaby Lake chip).</p>
</div>
<div class="paragraph">
<p>So I found myself in a situation where I needed to allow the TV get out to the internet, despite my misgivings.</p>
</div>
<div class="paragraph">
<p>But this got me thinking - could I somehow limit it&#8217;s access to just Netflix?  I initally tried an IP-based ACL on the router, but there were some issues with that so I began to wonder was there a DNS-based approach I could take?</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_enter_dns_rpz">Enter DNS RPZ</h3>
<div class="paragraph">
<p>I am relatively familiar with Bind having used it down through the years, and one feature in particular suggested it might help - Response Policy Zones.</p>
</div>
<div class="paragraph">
<p>Basically RPZ can be used to create a DNS "firewall," limiting what domains can be resolved.  There is plenty of information online about how this can be set up, however I didn&#8217;t find anything specifically explaining how to do what I needed (a total blacklist with only a very small whitelist of domains).</p>
</div>
<div class="paragraph">
<p>Turns out it&#8217;s fairly easy to do.</p>
</div>
</div>
<div class="sect2">
<h3 id="_bind_configuration">Bind Configuration</h3>
<div class="paragraph">
<p>The first step is to get a basic Bind resolver up and running.  I did this with a Ubuntu 16.04 system.</p>
</div>
<div class="paragraph">
<p>I then configured a 'response-policy' block in the 'options' section of my named.conf (on my particular system I did it in /etc/bind/named.conf.options).  This lists two RPZ zones which are used to define what queries to filter.  The key thing here is that RPZ checks zones in the order they are listed - this is key to creating a whitelist as opposed to a blacklist.  A single line is required:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>response-policy { zone "rpz.whitelist"; zone "rpz"; };</pre>
</div>
</div>
<div class="paragraph">
<p>All queries will then be filtered based on the response policy zones listed.  If a match is found in the first (rpz.whitelist) then that will be used, otherwise the second one (rpz) will be checked.</p>
</div>
<div class="paragraph">
<p>The Bind server needs to be configured as authorititive master for these zones, similar to a standard zone, although with "allow-query" set to none.  Again this is in named.conf (in my case /etc/bind/named.conf.default-zones):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>zone "rpz.whitelist" {
   type master;
   file "/etc/bind/db.rpz.whitelist";
   allow-query { none; };
};</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>zone "rpz" {
   type master;
   file "/etc/bind/db.rpz";
   allow-query { none; };
};</pre>
</div>
</div>
<div class="paragraph">
<p>As can be seen the zone definitions reference the location of the zone files for each.  The files are created as follows, using the RPZ syntax.  The first zone, rpz.whitelist, is where to define the domains we want to allow.  In my case it looks like this:</p>
</div>
<div class="paragraph">
<p><em>/etc/bind/db.rpz.whitelist</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$TTL 60
@            IN    SOA  localhost. root.localhost.  (
                      4   ; serial
                      3H  ; refresh
                      1H  ; retry
                      1W  ; expiry
                      1H) ; minimum

                      IN     NS      localhost.

 netflix.com                 CNAME   rpz-passthru.
 *.netflix.com               CNAME   rpz-passthru.

 nflximg.com                 CNAME   rpz-passthru.
 *.nflximg.com               CNAME   rpz-passthru.

 nflximg.net                 CNAME   rpz-passthru.
 *.nflximg.net               CNAME   rpz-passthru.</pre>
</div>
</div>
<div class="paragraph">
<p>Note that for each domain I have included the 'apex' record, and also a wildcard to catch all sub-domains.  In each case they are listed as CNAME records pointing to rpz-passthru, which is the RPZ syntax to tell Bind to allow queries for them.</p>
</div>
<div class="paragraph">
<p>The second RPZ zone file is created as follows.  This is configured for all sub-domains of the root zone, with a CNAME pointing to "." (which tells RPZ to return NXDOMAIN for such a lookup).  As the trailing dot (root zone) is left out of entries in RPZ zones, an asterix on it&#8217;s own is all that is needed to represent subdomains of the DNS root:</p>
</div>
<div class="paragraph">
<p><em>/etc/bind/db.rpz</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$TTL 60
@            IN    SOA  localhost. root.localhost.  (
                     4   ; serial
                     3H  ; refresh
                     1H  ; retry
                     1W  ; expiry
                     1H) ; minimum
             IN    NS    localhost.

*                  CNAME   .</pre>
</div>
</div>
<div class="paragraph">
<p>With the config in place I was able to reload Bind and check if it was working.</p>
</div>
</div>
<div class="sect2">
<h3 id="_results">Results</h3>
<div class="paragraph">
<p>So does it work.  If I try to resolve a random domain I get an NXDOMAIN response:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>topranks@dnsvm:~$ dig A www.samsung.com @localhost

; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; A www.samsung.com @localhost
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 14003
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.samsung.com.		IN	A</pre>
</div>
</div>
<div class="paragraph">
<p>And if I try for a sub-domain of netflix.com I get a valid response:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>topranks@dnsvm:~$ dig A www.netflix.com @localhost

; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; A www.netflix.com @localhost
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 59390
;; flags: qr rd ra; QUERY: 1, ANSWER: 10, AUTHORITY: 4, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.netflix.com.		IN	A

;; ANSWER SECTION:
www.netflix.com.	1800	IN	CNAME	www.geo.netflix.com.
www.geo.netflix.com.	1800	IN	CNAME	www.eu-west-1.prodaa.netflix.com.
www.eu-west-1.prodaa.netflix.com. 60 IN	A	52.209.165.126
www.eu-west-1.prodaa.netflix.com. 60 IN	A	52.19.164.15
www.eu-west-1.prodaa.netflix.com. 60 IN	A	52.208.178.51
www.eu-west-1.prodaa.netflix.com. 60 IN	A	52.209.156.83
www.eu-west-1.prodaa.netflix.com. 60 IN	A	52.208.202.184
www.eu-west-1.prodaa.netflix.com. 60 IN	A	52.208.15.72
www.eu-west-1.prodaa.netflix.com. 60 IN	A	52.208.81.52
www.eu-west-1.prodaa.netflix.com. 60 IN	A	52.208.174.58</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_additions_for_my_smart_tv_case">Additions for my Smart TV case</h3>
<div class="paragraph">
<p>In addition to the above I changed the ACL on for traffic coming from the TV to only allow TCP on ports 80 and 443, which is enough for Netflix, but importantly blocks the TV from using any external DNS (even in normal circumstances it looks like the TV will use 8.8.8.8 in addition to any configured DNS server entered on it).</p>
</div>
<div class="paragraph">
<p>Finally on the TV I changed the DNS server and sure enough the TV thinks something is wrong with DNS:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://cloud.githubusercontent.com/assets/4465905/26027929/bd59e8b2-380e-11e7-81b1-b8b2b8fd2ffe.JPG" alt="Samsung Error Message">
</div>
</div>
<div class="paragraph">
<p>So far so good, and yes the Netflix app still works fine.  Looking closely at my Bind logs I can see what&#8217;s happening:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Apr 20 17:42:27 dnsvm named[7369]: 13-May-2017 17:42:27.003 queries: info: client 192.168.240.42#40665 (art-0.nflximg.net): query: art-0.nflximg.net IN A + (192.168.240.32)
Apr 20 17:42:27 dnsvm named[7369]: 13-May-2017 17:42:27.003 rpz: info: client 192.168.240.42#40665 (art-0.nflximg.net): rpz QNAME PASSTHRU rewrite art-0.nflximg.net via art-0.nflximg.net.rpz.netflix
Apr 20 17:42:27 dnsvm named[7369]: 13-May-2017 17:42:27.766 queries: info: client 192.168.240.42#34179 (ns11.whois.co.kr): query: ns11.whois.co.kr IN A + (192.168.240.32)
Apr 20 17:42:27 dnsvm named[7369]: 13-May-2017 17:42:27.766 rpz: info: client 192.168.240.42#34179 (ns11.whois.co.kr): rpz QNAME NXDOMAIN rewrite ns11.whois.co.kr via ns11.whois.co.kr.rpz
Apr 20 17:42:29 dnsvm named[7369]: 13-May-2017 17:42:29.031 queries: info: client 192.168.240.42#59989 (time.samsungcloudsolution.com): query: time.samsungcloudsolution.com IN A + (192.168.240.32)
Apr 20 17:42:29 dnsvm named[7369]: 13-May-2017 17:42:29.031 rpz: info: client 192.168.240.42#59989 (time.samsungcloudsolution.com): rpz QNAME NXDOMAIN rewrite time.samsungcloudsolution.com via time.samsungcloudsolution.com.rpz
Apr 20 17:42:29 dnsvm named[7369]: 13-May-2017 17:42:29.033 queries: info: client 192.168.240.42#36357 (time.samsungcloudsolution.com): query: time.samsungcloudsolution.com IN A + (192.168.240.32)
Apr 20 17:42:29 dnsvm named[7369]: 13-May-2017 17:42:29.033 rpz: info: client 192.168.240.42#36357 (time.samsungcloudsolution.com): rpz QNAME NXDOMAIN rewrite time.samsungcloudsolution.com via time.samsungcloudsolution.com.rpz</pre>
</div>
</div>
<div class="paragraph">
<p>So yeah, probably not ideal as the TV can still get out to the internet, at least on 80 and 443 TCP, but without DNS I&#8217;ve hopefully limited how much it can do.</p>
</div>
</div>
        </div>

        <menu>
            <a href="" id="btn_share" class="btn" title="Share">
                <span aria-hidden="true" data-icon="S"></span>
                <strong>Share</strong>
            </a>
            <a href="http://twitter.com/share?text=DNS%20Whitelist%20in%20BIND%20with%20RPZ&url=http://blog.rankinrez.net/2017/05/13/DNS-Whitelist-in-BIND-with-RPZ.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" id="btn_comment" class="btn" target="_blank">
                <span aria-hidden="true" data-icon="C"></span> Comment on Twitter
            </a>
        </menu>


        <footer class="post-footer" role="contentinfo">

            <div class="vcard">
                <a href="http://blog.rankinrez.net/rss" id="btn_feed" class="btn" title="Feed" target="_blank">
                    <span aria-hidden="true" data-icon=")"></span>
                    <strong>Feed</strong>
                </a>

                <a href="http://blog.rankinrez.net/author/topranks/" class="photo">
                    <span style="background-image: url('https://avatars1.githubusercontent.com/u/4465905?v&#x3D;3');">
                        <img src="https://avatars1.githubusercontent.com/u/4465905?v&#x3D;3" alt="Cathal Mooney">
                    </span>
                </a>

                <div class="details">
                    <h4><a href="http://blog.rankinrez.net/author/topranks/" class="url n">Cathal Mooney</a></h4>
                    
                    
                </div>
            </div>

            <div id="user_bio">
                <div class="inner">
                    
                </div>
            </div>

        </footer>




    </article>

    <div id="share_modal">
        <div class="wrap">
            <div class="inner">
                <header>
                    Share
                    <a href="" class="close" title="Close">&times;</a>
                </header>

                <div class="roon-share-links">
                    <a href="https://twitter.com/share" class="twitter-share-button" data-dnt="true">Tweet</a>
                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

                    <div id="fb-elems">
                        <div id="fb-root"></div>
                        <script>(function(d, s, id) {
                        var js, fjs = d.getElementsByTagName(s)[0];
                        if (d.getElementById(id)) return;
                        js = d.createElement(s); js.id = id;
                        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=463438580397968";
                        fjs.parentNode.insertBefore(js, fjs);
                        }(document, 'script', 'facebook-jssdk'));</script>
                        <div class="fb-like" data-send="false" data-layout="button_count" data-width="110" data-show-faces="false" data-font="arial"></div>
                    </div>

                    <div id="pinit-btn">
                        <a href="//pinterest.com/pin/create/button/?url=http://blog.rankinrez.net/2017/05/13/DNS-Whitelist-in-BIND-with-RPZ.html&amp;description=DNS%20Whitelist%20in%20BIND%20with%20RPZ-%5Bobject%20Object%5D " data-pin-do="buttonPin" data-pin-config="beside"><img src="//assets.pinterest.com/images/pidgets/pin_it_button.png"></a>
                        <script type="text/javascript" src="//assets.pinterest.com/js/pinit.js"></script>
                    </div>
                </div>
            </div>
        </div>
    </div>






    <script>

            function get_text(el) {
                ret = "";
                var length = el.childNodes.length;
                for(var i = 0; i < length; i++) {
                    var node = el.childNodes[i];
                    if(node.nodeType != 8) {
                        ret += node.nodeType != 1 ? node.nodeValue : get_text(node);
                    }
                }
                return ret;
            }
            function reading_time () {
                var post_content = document.getElementById('js-post-content');
                if (post_content) {
                    var words = get_text(post_content),
                        count = words.split(/\s+/).length,
                        read_time = Math.ceil((count / 150)),
                        read_time_node = document.createTextNode(read_time + ' min read');
                    document.getElementById('js-reading-time').appendChild(read_time_node);
                }
            }

        function no_schema_links () {
            var links = document.querySelectorAll('.js-remove-domain-schema');
            if (links) {
                for (i = 0; i < links.length; ++i) {
                    var link = links[i],
                        text = link.innerHTML,
                        no_schema = text.replace(/.*?:\/\//g, "");
                    link.innerHTML = no_schema;
                }
            }
        }

        window.onload = function () {
            no_schema_links();

            reading_time();
        }
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();
      </script>
       
    <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

        <script>
            $(function(){
                var share_modal = $("#share_modal"),
                    update_social_links = true;

                $("#btn_share").click(function(){
                    var that = $(this);
                    share_modal.fadeIn(200);
                    return false;
                });

                share_modal.click(function(e){
                    if (e.target.className == "wrap" || e.target.id == "share_modal") {
                        share_modal.fadeOut(200);
                    }
                    return false;
                });

                share_modal.find("div.inner > header > a.close").click(function(){
                    share_modal.fadeOut(200);
                    return false;
                });
            });
        </script>



</body>
</html>
